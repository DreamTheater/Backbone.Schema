/**
 * Backbone.Schema v0.3.4
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
!function(){"use strict";var a=Backbone.Schema=function(a){this.attributes={},this.model=_.extend(a,{toJSON:_.wrap(a.toJSON,function(a,b){var c=a.call(this,b);return _.each(c,function(a,c,d){a instanceof Backbone.Model?a=a.source?a.id:a.toJSON(b):a instanceof Backbone.Collection&&(a=a.source?_.pluck(a.models,"id"):a.toJSON(b)),d[c]=a}),c}),get:_.wrap(a.get,function(a,b){var c=this.schema,d=a.call(this,b),e=this.attributes;return c.formatValue(d,b,e)}),set:_.wrap(a.set,function(a,b,c,d){var e;!b||_.isObject(b)?(e=b,d=c):(e={})[b]=c;var f={};return _.each(e,function(a,b,c){var d=this.schema,e=d.parseValue(a,b,c);_.extend(f,e)},this),a.call(this,f,d)})},{schema:this})};_.extend(a,{types:{string:{getter:function(a,b){return b},setter:function(a,b){return String(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return Boolean(b)}},number:{getter:function(a,b,c){var d=c.format||"n",e=c.culture;return Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.culture;return b=String(b),Globalize.parseFloat(b,d)}},datetime:{getter:function(a,b,c){var d=c.format||"d",e=c.culture;return b=new Date(b),Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.format||"d",e=c.culture,f=c.standard;b=Globalize.parseDate(b,d,e)||new Date(b);var g;switch(f){case"unix":g=b.getTime();break;default:try{g=b.toISOString()}catch(h){g=b.toString()}}return g}},locale:{getter:function(a,b,c){var d=c.culture;return Globalize.localize(b,d)||b},setter:function(a,b,c){var d=c.culture;b=String(b);var e,f=Globalize.findClosestCulture(d).messages,g=_.pairs(f);return e=_.find(g,function(a){return a[1]===b}),e?e[0]:b}},text:{getter:function(a,b){return _.unescape(b)},setter:function(a,b){return b=_.unescape(b),_.escape(b)}},model:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.model,f=c.fromSource;c=_.extend({reset:!0},{parse:!0,silent:!1},c),d=c.reset;var g=this.get(a),h=f?f.get(b):b;return h instanceof e?g=h:g instanceof e?d?g.clear().set(h,c):g.set(h,c):g=new e(h,c),g.source=f||null,g}},collection:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.collection,f=c.fromSource;c=_.extend({reset:!0},{parse:!0,silent:!1},c),d=c.reset;var g=this.get(a),h=f?f.filter(function(a){return _.contains(b,a.id)}):b;return g instanceof e?d?g.reset(h,c):g.set(h,c):g=new e(h,c),g.source=f||null,g}}}}),_.extend(a.prototype,{define:function(a,b){var c;return!a||_.isObject(a)?c=a:(c={})[a]=b,_.each(c,function(a,b){this._addAttribute(b,a)},this),this},refreshValue:function(a,b){var c=this.model,d=c.attributes[a];return c.set(a,d,b),this},defaultValue:function(a){var b,c=this.model,d=_.result(c,"defaults")||{};return b=d[a],_.isUndefined(b)&&(b=null),b},formatValue:function(a,b,c){var d=this.model,e=this.attributes[b]||{},f=e.getter;return f?f.call(d,b,a):c[b]},parseValue:function(a,b,c){var d=this.model,e=this.attributes[b]||{},f=e.setter;return f?f.call(d,b,a):_.pick(c,b)},_addAttribute:function(a,b){var c=b.type,d=b.arrayOf,e=b.model,f=b.collection,g=!1;c||(d?(c=d,g=!0):e?c="model":f&&(c="collection"));var h=this.constructor.types[c],i=h.getter,j=h.setter;this.attributes[a]=_.defaults(b,{getter:_.wrap(i,function(a,c,d){var e,f=g?d:[d];return e=_.map(f,function(d){return a.call(this,c,d,b)},this),g?e:e[0]}),setter:_.wrap(j,function(a,c,d){var e={},f=[],h=g?d:[d];return _.each(h,function(d){var e=this.schema;d=_.isUndefined(d)?e.defaultValue(c):d;var h=_.isNull(d)?d:a.call(this,c,d,b);g&&(_.isNull(h)||_.isUndefined(h))||f.push(h)},this),e[c]=g?f:f[0],e})}),this.refreshValue(a,b)}})}();