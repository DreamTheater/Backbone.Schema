/**
 * Backbone.Schema v0.4.9
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2015 Dmytro Nemoga
 * Released under the MIT license
 */
!function(a){"use strict";var b="object"==typeof module&&"object"==typeof exports,c=b?{_:require("underscore"),Backbone:require("backbone"),Globalize:require("globalize")}:window;(b?exports:Backbone).Schema=a(c,b)}(function(a){"use strict";var b=a._,c=a.Backbone,d=a.Globalize,e=c.Schema=function(a){return this instanceof e?(this.model=a,this.attributes={},a.schema=this,void b.extend(a,{toJSON:b.wrap(a.toJSON,function(a,d){var e=a.call(this,d);return b.each(e,function(a,e,f){a instanceof c.Model?a=a.source?a.id:a.toJSON(d):a instanceof c.Collection&&(a=a.source?b.pluck(a.models,"id"):a.toJSON(d)),f[e]=a}),e}),get:b.wrap(a.get,function(a,b){var c=this.schema.attributes[b],d=c&&c.getter,e=a.call(this,b);return d?d(b,e):e}),set:b.wrap(a.set,function(a,c,d,e){var f;!c||b.isObject(c)?(f=c,e=d):(f={})[c]=d;var g={};return b.each(f,function(a,c,d){var e=this.schema.attributes[c],f=e&&e.setter,h=f?f(c,a):b.pick(d,c);b.each(h,function(a,b){g[b]=a})},this),a.call(this,g,e)})})):new e(a)};return b.extend(e,{extend:c.Model.extend},{handlers:{string:{getter:function(a,b){return b},setter:function(a,c){return b.isString(c)?c:String(c)}},"boolean":{getter:function(a,b){return b},setter:function(a,c){return b.isBoolean(c)?c:Boolean(c)}},number:{getter:function(a,b,c){var e=c.culture,f=c.format;return f?d.format(b,f,e):b},setter:function(a,c,e){var f=e.culture,g=Number(c);return isNaN(g)&&(g=b.isString(c)?c:String(c)),b.isNumber(g)?g:d.parseFloat(g,f)||"NaN"}},datetime:{getter:function(a,c,e){var f=e.culture,g=e.format;return b.isDate(c)||(c=new Date(c)),g?d.format(c,g,f):c},setter:function(a,b,c){var e=c.culture,f=c.format,g=c.standard;b=f?d.parseDate(b,f,e)||new Date(b):new Date(b);var h;switch(g){case"iso":h=b.toJSON()?b.toISOString():b.toString();break;case"unix":h=b.getTime();break;default:h=b}return h}},locale:{getter:function(a,b,c){var e=c.culture;return d.localize(b,e)||b},setter:function(a,c,e){var f,g=e.culture,h=d.findClosestCulture(g).messages;return b.find(h,function(a,b){return a===c?f=b:!1}),f||String(c)}},model:{getter:function(a,b){return b},setter:function(a,d,e){e=b.clone(e);var f,g=e.source,h=e.clear;f=e.model||g.model;var i,j=this.model.get(a);return i=d instanceof c.Model?d===j?d:b.clone(d.attributes):g?g.get(d):d,i instanceof f?j=i:j instanceof f?h?j.clear().set(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}},collection:{getter:function(a,b){return b},setter:function(a,d,e){e=b.clone(e);var f,g=e.source,h=e.reset;f=e.collection||g.constructor;var i,j=this.model.get(a);return i=d instanceof c.Collection?d===j?d:b.clone(d.models):g?g.filter(function(a){return b.contains(d,a.id)}):d,i instanceof f?j=i:j instanceof f?h?j.reset(i,e):j.set(i,e):j=new f(i,e),j.source=g||null,j}}}}),b.extend(e.prototype,{constructor:e},{define:function(a,c){var d;return!a||b.isObject(a)?d=a:(d={})[a]=c,b.each(d,function(a,b){a=a||{},this._addAttribute(b,a)},this),this.refresh(),this},refresh:function(){var a=this.attributes,c={};return b.each(a,function(a,b){c[b]=this.model.attributes[b]},this),this.model.set(c),this},defaultValue:function(a){var c=b.result(this.model,"defaults");return c&&b.has(c,a)?c[a]:null},_addAttribute:function(a,c){var d=c.type,e=c.array,f=c.model,g=c.collection;d||(e?d=e:f?d="model":g&&(d="collection"));var h=this.constructor,i=h.handlers[d],j=i&&i.getter,k=i&&i.setter;return this.attributes[a]=b.defaults(c,{getter:b.wrap(j,function(a,d,f){var g=[],h=e?f:[f];return b.each(h,function(e){var f;f=b.isNull(e)?e:a?a.call(this,d,e,c):e,g.push(f)},this),e?g:g[0]}),setter:b.wrap(k,function(a,f,g){var h=[],i=e?g:[g];return b.each(i,function(e){b.isUndefined(e)&&(e=this.defaultValue(f));var g;if(b.isNull(e))switch(d){case"model":g=a?a.call(this,f,{},c):e;break;case"collection":g=a?a.call(this,f,[],c):e;break;default:g=e}else g=a?a.call(this,f,e,c):e;h.push(g)},this),b.object([f],[e?h:h[0]])})}),this._bindHandlers(c),this},_bindHandlers:function(a){var c=a.getter,d=a.setter;return c&&(a.getter=b.bind(c,this)),d&&(a.setter=b.bind(d,this)),this}}),e});