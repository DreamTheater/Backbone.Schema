/**
 * Backbone.Schema v0.2.9
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
!function(){"use strict";function a(a,b,c){for(var d in a)a.hasOwnProperty(d)&&b.call(c,a[d],d,a)}var b=Backbone.Model;Backbone.Model=b.extend({constructor:function(a,c){this._schema={},this.initialize=_.wrap(this.initialize,function(a,b,c){return a.call(this,b,c)}),b.call(this,a,c)},toJSON:_.wrap(b.prototype.toJSON,function(a,b){return this.sourceCollection?this.id:function(a,b){var c=a.call(this,b);return _.each(c,function(a,c,d){(a instanceof Backbone.Model||a instanceof Backbone.Collection)&&(d[c]=a.toJSON(b))}),c}.call(this,a,b)}),get:_.wrap(b.prototype.get,function(a,b){var c=a.call(this,b);return this._formatValue(c,b)}),set:_.wrap(b.prototype.set,function(b,c,d,e){var f;!c||_.isObject(c)?(f=c,e=d):(f={})[c]=d;var g={};return a(f,function(b,c,d){var e=this._convertValue(b,c,d);a(e,function(a,b){g[b]=a})},this),b.call(this,g,e)}),property:function(a,b){var c=b.type,d=b.arrayOf,e=!1;c||(d?(c=d,e=!0):b.model?c="model":b.collection&&(c="collection"));var f=this.constructor.processors[c],g=f.getter,h=f.setter,i=this.attributes[a];return this._schema[a]=_.defaults(b,{getter:_.wrap(g,function(a,c,d){var f,g=e?d:[d];return f=_.map(g,function(d){return a.call(this,c,d,b)}),e?f:f[0]}),setter:_.wrap(h,function(a,c,d){var f={},g=[],h=e?d:[d];return _.each(h,function(d){d=_.isUndefined(d)?this._getDefaultValue(c):d;var f=_.isNull(d)?d:a.call(this,c,d,b);e&&(_.isNull(f)||_.isUndefined(f))||g.push(f)},this),f[c]=e?g:g[0],f})}),this.set(a,i)},_formatValue:function(a,b){var c=this._schema[b]||{},d=c.getter;return d?d.call(this,b,a):a},_convertValue:function(a,b,c){var d=this._schema[b]||{},e=d.setter;return e?e.call(this,b,a):_.pick(c,b)},_getDefaultValue:function(a){var b,c=_.result(this,"defaults")||{};return b=c[a],_.isUndefined(b)&&(b=null),b}},{processors:{string:{getter:function(a,b){return b},setter:function(a,b){return String(b)}},number:{getter:function(a,b,c){var d=Number(c.decimals);return d=_.isNaN(d)?2:d,Globalize.format(b,"n"+d)},setter:function(a,b){return b=String(b),Globalize.parseFloat(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return Boolean(b)}},datetime:{getter:function(a,b,c){return b=new Date(b),Globalize.format(b,c.format||"d")},setter:function(a,b,c){b=Globalize.parseDate(b,c.format||"d")||new Date(b);var d;switch(c.method){case"unix":d=b.getTime();break;case"iso":d=b.toISOString();break;default:d=b.toString()}return d}},text:{getter:function(a,b){return _.unescape(b)},setter:function(a,b){return b=_.unescape(b),_.escape(b)}},currency:{getter:function(a,b,c){var d=Number(c.decimals);return d=_.isNaN(d)?2:d,Globalize.format(b,"c"+d)},setter:function(a,b){return b=String(b),Globalize.parseFloat(b)}},percent:{getter:function(a,b,c){var d=Number(c.decimals);return d=_.isNaN(d)?2:d,Globalize.format(b,"p"+d)},setter:function(a,b){return b=_.isNumber(b)?String(100*b):String(b),Globalize.parseFloat(b)/100}},locale:{getter:function(a,b){return Globalize.localize(b)||b},setter:function(a,b){b=String(b);var c,d=Globalize.culture(),e=_.pairs(d.messages);return c=_.find(e,function(a){return a[1]===b})||[],c[0]||b}},model:{getter:function(a,b){return b},setter:function(a,b,c){var d=c.fromSource||null;d&&(b=d.get(b)),b=b instanceof Backbone.Model?b.attributes:b;var e=c.model,f=this.get(a);return f instanceof e?f.clear().set(b):(f=new e(b),f.sourceCollection=d),f}},collection:{getter:function(a,b){return b},setter:function(a,b,c){var d=c.fromSource||null;d&&(b=d.filter(function(a){return _.contains(b,a.id)})),b=b instanceof Backbone.Collection?b.models:b;var e=c.collection,f=this.get(a);return f instanceof e?f.reset(b):(f=new e(b),f.sourceCollection=d),f}}}})}(),function(){"use strict";var a=Backbone.Collection;Backbone.Collection=a.extend({model:Backbone.Model,constructor:function(b,c){this.initialize=_.wrap(this.initialize,function(a,b,c){return a.call(this,b,c)}),a.call(this,b,c)},toJSON:_.wrap(a.prototype.toJSON,function(a,b){return this.sourceCollection?_.pluck(this.models,"id"):a.call(this,b)})})}();