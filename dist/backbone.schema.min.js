/**
 * Backbone.Schema v0.3.8
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
!function(){"use strict";var a=Backbone.Schema=function(b){return this instanceof a?(this.attributes={},_.extend(this,{model:b}),_.extend(b,{schema:this},{toJSON:_.wrap(b.toJSON,function(a,b){var c=a.call(this,b);return _.each(c,function(a,c,d){a instanceof Backbone.Model?a=a.source?a.id:a.toJSON(b):a instanceof Backbone.Collection&&(a=a.source?_.pluck(a.models,"id"):a.toJSON(b)),d[c]=a}),c}),get:_.wrap(b.get,function(a,b){var c=(this.schema.attributes[b]||{}).getter,d=a.call(this,b);return c?c(b,d):this.attributes[b]}),set:_.wrap(b.set,function(a,b,c,d){var e;!b||_.isObject(b)?(e=b,d=c):(e={})[b]=c;var f={};return _.each(e,function(a,b,c){var d=(this.schema.attributes[b]||{}).setter,e=d?d(b,a):_.pick(c,b);_.each(e,function(a,b){f[b]=a})},this),a.call(this,f,d)})},{refresh:function(){var a=_.clone(this.schema.attributes);return _.each(a,function(a,b,c){c[b]=this.attributes[b]},this),this.set(a),this}}),void 0):new a(b)};_.extend(a,{types:{string:{getter:function(a,b){return b},setter:function(a,b){return String(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return Boolean(b)}},number:{getter:function(a,b,c){var d=c.format||"n",e=c.culture;return Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.culture;return b=String(b),Globalize.parseFloat(b,d)||Number(b)}},datetime:{getter:function(a,b,c){var d=c.format||"d",e=c.culture;return b=new Date(b),Globalize.format(b,d,e)},setter:function(a,b,c){var d=c.format||"d",e=c.culture,f=c.standard;b=Globalize.parseDate(b,d,e)||new Date(b);var g;switch(f){case"unix":g=b.getTime();break;default:try{g=b.toISOString()}catch(h){g=b.toString()}}return g}},locale:{getter:function(a,b,c){var d=c.culture;return Globalize.localize(b,d)||b},setter:function(a,b,c){var d=c.culture;b=String(b);var e,f=Globalize.findClosestCulture(d).messages,g=_.pairs(f);return e=_.find(g,function(a){return a[1]===b}),e?e[0]:b}},text:{getter:function(a,b){return _.unescape(b)},setter:function(a,b){return b=_.unescape(b),_.escape(b)}},model:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.source,f=c.reset;d=c.model||e.model,c=_.extend({parse:!0,silent:!1},c);var g=this.get(a),h=e?e.get(b):b;return h instanceof d?g=h:g instanceof d?f===!1?g.set(h,c):g.clear().set(h,c):g=new d(h,c),g.source=e||null,g}},collection:{getter:function(a,b){return b},setter:function(a,b,c){var d,e=c.source,f=c.reset;d=c.collection||e.constructor,c=_.extend({parse:!0,silent:!1},c);var g=this.get(a),h=e?e.filter(function(a){return _.contains(b,a.id)}):b;return g instanceof d?f===!1?g.set(h,c):g.reset(h,c):g=new d(h,c),g.source=e||null,g}}}}),_.extend(a.prototype,{constructor:a,define:function(a,b){var c;return!a||_.isObject(a)?c=a:(c={})[a]=b,_.each(c,function(a,b){this._addAttribute(b,a)},this),this.model.refresh(),this},defaultValue:function(a){var b,c=_.result(this.model,"defaults")||{};return b=c[a],_.isUndefined(b)&&(b=null),b},_addAttribute:function(a,b){var c=b.type,d=b.array,e=b.model,f=b.collection;c||(d?c=d:e?c="model":f&&(c="collection"));var g=this.constructor.types[c]||{};this.attributes[a]=_.defaults(b,{getter:_.wrap(g.getter,function(a,c,e){var f=[],g=d?e:[e];return _.each(g,function(d){var e;e=_.isNull(d)?d:a?a.call(this,c,d,b):d,f.push(e)},this),d?f:f[0]}),setter:_.wrap(g.setter,function(a,e,f){var g=[],h=d?f:[f];return _.each(h,function(d){_.isUndefined(d)&&(d=this.schema.defaultValue(e));var f;if(_.isNull(d))switch(c){case"model":f=a?a.call(this,e,{},b):d;break;case"collection":f=a?a.call(this,e,[],b):d;break;default:f=d}else f=a?a.call(this,e,d,b):d;g.push(f)},this),_.object([e],[d?g:g[0]])})}),this._bindHandlers(b)},_bindHandlers:function(a){var b=a.getter,c=a.setter,d=this.model;b&&(a.getter=_.bind(b,d)),c&&(a.setter=_.bind(c,d))}})}();