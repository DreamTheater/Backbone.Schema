/**
 * Backbone.Schema v0.3.2
 * https://github.com/DreamTheater/Backbone.Schema
 *
 * Copyright (c) 2013 Dmytro Nemoga
 * Released under the MIT license
 */
!function(){"use strict";var a=Backbone.Schema=function(a){this.attributes={};var b=_.bind(function(a,b){var c=this.model,d=a.call(c,b);return _.each(d,function(a,c,d){a instanceof Backbone.Model?a=a.sourceCollection?a.id:a.toJSON(b):a instanceof Backbone.Collection&&(a=a.sourceCollection?_.pluck(a.models,"id"):a.toJSON(b)),d[c]=a}),d},this),c=_.bind(function(a,b){var c=this.model,d=a.call(c,b),e=c.attributes;return this._formatValue(d,b,e)},this),d=_.bind(function(a,b,c,d){var e,f=this.model;!b||_.isObject(b)?(e=b,d=c):(e={})[b]=c;var g={};return _.each(e,function(a,b,c){var d=this._parseValue(a,b,c);_.extend(g,d)},this),a.call(f,g,d)},this);this.model=_.extend(a,{toJSON:_.wrap(a.toJSON,b),get:_.wrap(a.get,c),set:_.wrap(a.set,d)})};_.extend(a,{types:{string:{getter:function(a,b){return b},setter:function(a,b){return String(b)}},number:{getter:function(a,b,c){return c=_.extend({format:"n"},c),Globalize.format(b,c.format)},setter:function(a,b){return b=String(b),Globalize.parseFloat(b)}},"boolean":{getter:function(a,b){return b},setter:function(a,b){return Boolean(b)}},datetime:{getter:function(a,b,c){return c=_.extend({format:"d"},c),b=new Date(b),Globalize.format(b,c.format)},setter:function(a,b,c){c=_.extend({format:"d"},c),b=Globalize.parseDate(b,c.format)||new Date(b);var d;switch(c.standard){case"unix":d=b.getTime();break;default:try{d=b.toISOString()}catch(e){d=b.toString()}}return d}},text:{getter:function(a,b){return _.unescape(b)},setter:function(a,b){return b=_.unescape(b),_.escape(b)}},locale:{getter:function(a,b){return Globalize.localize(b)||b},setter:function(a,b){b=String(b);var c,d=Globalize.culture(),e=_.pairs(d.messages);return c=_.find(e,function(a){return a[1]===b})||[],c[0]||b}},model:{getter:function(a,b){return b},setter:function(a,b,c){c=_.extend({reset:!0,parse:!0,silent:!1},c);var d,e=c.fromSource;b=e?e.get(b):b,d=b instanceof Backbone.Model?b.attributes:b;var f=c.model,g=this.get(a);return g instanceof f?c.reset?g.clear().set(d,c):g.set(d,c):(g=new f(d,c),g.sourceCollection=e),g}},collection:{getter:function(a,b){return b},setter:function(a,b,c){c=_.extend({reset:!0,parse:!0,silent:!1},c);var d,e=c.fromSource;b=e?e.filter(function(a){return _.contains(b,a.id)}):b,d=b instanceof Backbone.Collection?b.models:b;var f=c.collection,g=this.get(a);return g instanceof f?c.reset?g.reset(d,c):g.set(d,c):(g=new f(d,c),g.sourceCollection=e),g}}}}),_.extend(a.prototype,{define:function(a,b){var c;return!a||_.isObject(a)?c=a:(c={})[a]=b,_.each(c,function(a,b){this._addAttribute(b,a)},this),this._refreshValues(c),this},_addAttribute:function(a,b){var c=b.type,d=b.arrayOf,e=!1;c||(d?(c=d,e=!0):b.model?c="model":b.collection&&(c="collection"));var f=this.constructor.types[c],g=f.getter,h=f.setter;this.attributes[a]=_.defaults(b,{getter:_.wrap(g,function(a,c,d){var f,g=e?d:[d];return f=_.map(g,function(d){var e=this.model;return a.call(e,c,d,b)},this),e?f:f[0]}),setter:_.wrap(h,function(a,c,d){var f={},g=[],h=e?d:[d];return _.each(h,function(d){var f=this.model;d=_.isUndefined(d)?this._pickDefaultValue(c):d;var h=_.isNull(d)?d:a.call(f,c,d,b);e&&(_.isNull(h)||_.isUndefined(h))||g.push(h)},this),f[c]=e?g:g[0],f})})},_refreshValues:function(a){var b=this.model;a=_.keys(a),a=_.pick(b.attributes,a),b.set(a)},_formatValue:function(a,b,c){var d=this.attributes[b]||{},e=d.getter;return e?e.call(this,b,a):c[b]},_parseValue:function(a,b,c){var d=this.attributes[b]||{},e=d.setter;return e?e.call(this,b,a):_.pick(c,b)},_pickDefaultValue:function(a){var b,c=this.model,d=_.result(c,"defaults")||{};return b=d[a],_.isUndefined(b)&&(b=null),b}})}();